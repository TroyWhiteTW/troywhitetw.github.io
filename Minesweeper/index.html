<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>踩地雷 2</title>

    <style>
        #div2 {
            width: 200px;
            height: 200px;
            background: lightgray;
            position: absolute;
            left: -220px;
            top: 300px;
            padding: 10px;
        }

        #div2 span {
            width: 20px;
            height: 80px;
            line-height: 20px;
            right: -20px;
            top: 60px;
            background: pink;
            position: absolute;
        }
    </style>

    <script src="ajax.js"></script>
    <script>
        class Cells {
            constructor(x, y) {
                this.blockX = x;
                this.blockY = y;
                this.backgroundColor = 'yellow';
                this.isBomb = false;
                this.countBombs = 0;
                this.status = 0;
                this.tag = 0;
            }

            leftClick(changeView, endGame) {
                if (this.status === 0 && this.tag === 0) {
                    if (this.isBomb) {
                        this.status = 1;

                        endGame();
                    } else {
                        this.status = 1;
                        this.backgroundColor = 'gray';

                        changeView();
                    }
                }
            }

            rightClick(changeView) {
                if (this.status === 0) {
                    if (this.tag === 0) {
                        this.tag = 1;
                        this.backgroundColor = 'blue';
                    } else {
                        this.tag = 0;
                        this.backgroundColor = 'yellow';
                    }

                    changeView();
                }
            }
        }

        const CELL_WIDTH = 30;

        let columns = 0;
        let rows = 0;
        let bombs = 0;

        let aBombs;
        let aCells;

        let timer = null;
        let AutoSideBarTimer = null;

        function createBombsArray(columns, rows, bombs) {
            const ALL_CELLS = columns * rows;

            let originalArray = [];
            let returnArray = [bombs];

            for (let i = 0; i < ALL_CELLS; i++) {
                originalArray[i] = i;
            }
            originalArray.sort(() => 0.5 - Math.random());

            for (let i = 0; i < bombs; i++) {
                returnArray[i] = originalArray[i];
            }

            return returnArray;
        }

        function foreachAllCells(fCallback) {
            for (let i = 0; i < aCells.length; i++) {
                for (let j = 0; j < aCells[i].length; j++) {
                    fCallback(i, j);
                }
            }
        }

        function countBombs() {
            foreachAllCells((i, j) => {
                let bombs = 0;

                if (typeof aCells[i - 1] !== 'undefined') {
                    if (typeof aCells[i - 1][j - 1] !== 'undefined' &&
                        aCells[i - 1][j - 1].isBomb) {
                        bombs++;
                    }

                    if (typeof aCells[i - 1][j] !== 'undefined' &&
                        aCells[i - 1][j].isBomb) {
                        bombs++;
                    }

                    if (typeof aCells[i - 1][j + 1] !== 'undefined' &&
                        aCells[i - 1][j + 1].isBomb) {
                        bombs++;
                    }
                }

                if (typeof aCells[i][j - 1] !== 'undefined' &&
                    aCells[i][j - 1].isBomb) {
                    bombs++;
                }

                if (typeof aCells[i][j + 1] !== 'undefined' &&
                    aCells[i][j + 1].isBomb) {
                    bombs++;
                }

                if (typeof aCells[i + 1] !== 'undefined') {
                    if (typeof aCells[i + 1][j - 1] !== 'undefined' &&
                        aCells[i + 1][j - 1].isBomb) {
                        bombs++;
                    }

                    if (typeof aCells[i + 1][j] !== 'undefined' &&
                        aCells[i + 1][j].isBomb) {
                        bombs++;
                    }

                    if (typeof aCells[i + 1][j + 1] !== 'undefined' &&
                        aCells[i + 1][j + 1].isBomb) {
                        bombs++;
                    }
                }

                aCells[i][j].countBombs = bombs;
            });
        }

        function endGamePauseClick() {
            foreachAllCells((i, j) => {
                aCells[i][j].status = -1;
            });

            let oDivs = document.getElementById('div1').getElementsByTagName('div');

            for (let i = 0; i < aBombs.length; i++) {
                oDivs[aBombs[i]].style.backgroundColor = 'black';
            }

            clearInterval(timer);
        }

        function showCells(i, j) {
            let oDivs = document.getElementById('div1').getElementsByTagName('div');

            aCells[i][j].leftClick(
                () => {
                    if (aCells[i][j].countBombs !== 0) {
                        oDivs[i * columns + j].innerHTML = aCells[i][j].countBombs;
                    }
                    oDivs[i * columns + j].style.backgroundColor = aCells[i][j].backgroundColor;
                },
                () => {
                    alert('你踩到炸彈了！');

                    endGamePauseClick();
                }
            );

            if (aCells[i][j].countBombs !== 0) {

                if (aCells[i][j].status === 1) {
                    let tempBombs = 0;

                    if (typeof aCells[i - 1] !== 'undefined') {
                        if (typeof aCells[i - 1][j - 1] !== 'undefined' &&
                            aCells[i - 1][j - 1].tag === 1 &&
                            aCells[i - 1][j - 1].isBomb) {
                            tempBombs++;
                        }

                        if (typeof aCells[i - 1][j] !== 'undefined' &&
                            aCells[i - 1][j].tag === 1 &&
                            aCells[i - 1][j].isBomb) {
                            tempBombs++;
                        }

                        if (typeof aCells[i - 1][j + 1] !== 'undefined' &&
                            aCells[i - 1][j + 1].tag === 1 &&
                            aCells[i - 1][j + 1].isBomb) {
                            tempBombs++;
                        }
                    }

                    if (typeof aCells[i][j - 1] !== 'undefined' &&
                        aCells[i][j - 1].tag === 1 &&
                        aCells[i][j - 1].isBomb) {
                        tempBombs++;
                    }

                    if (typeof aCells[i][j + 1] !== 'undefined' &&
                        aCells[i][j + 1].tag === 1 &&
                        aCells[i][j + 1].isBomb) {
                        tempBombs++;
                    }

                    if (typeof aCells[i + 1] !== 'undefined') {
                        if (typeof aCells[i + 1][j - 1] !== 'undefined' &&
                            aCells[i + 1][j - 1].tag === 1 &&
                            aCells[i + 1][j - 1].isBomb) {
                            tempBombs++;
                        }

                        if (typeof aCells[i + 1][j] !== 'undefined' &&
                            aCells[i + 1][j].tag === 1 &&
                            aCells[i + 1][j].isBomb) {
                            tempBombs++;
                        }

                        if (typeof aCells[i + 1][j + 1] !== 'undefined' &&
                            aCells[i + 1][j + 1].tag === 1 &&
                            aCells[i + 1][j + 1].isBomb) {
                            tempBombs++;
                        }
                    }

                    if (tempBombs === aCells[i][j].countBombs) {
                        if (typeof aCells[i - 1] !== 'undefined') {
                            if (typeof aCells[i - 1][j - 1] !== 'undefined' &&
                                aCells[i - 1][j - 1].status === 0) {
                                showCells(i - 1, j - 1);
                            }

                            if (typeof aCells[i - 1][j] !== 'undefined' &&
                                aCells[i - 1][j].status === 0) {
                                showCells(i - 1, j);
                            }

                            if (typeof aCells[i - 1][j + 1] !== 'undefined' &&
                                aCells[i - 1][j + 1].status === 0) {
                                showCells(i - 1, j + 1);
                            }
                        }

                        if (typeof aCells[i][j - 1] !== 'undefined' &&
                            aCells[i][j - 1].status === 0) {
                            showCells(i, j - 1);
                        }

                        if (typeof aCells[i][j + 1] !== 'undefined' &&
                            aCells[i][j + 1].status === 0) {
                            showCells(i, j + 1);
                        }

                        if (typeof aCells[i + 1] !== 'undefined') {
                            if (typeof aCells[i + 1][j - 1] !== 'undefined' &&
                                aCells[i + 1][j - 1].status === 0) {
                                showCells(i + 1, j - 1);
                            }

                            if (typeof aCells[i + 1][j] !== 'undefined' &&
                                aCells[i + 1][j].status === 0) {
                                showCells(i + 1, j);
                            }

                            if (typeof aCells[i + 1][j + 1] !== 'undefined' &&
                                aCells[i + 1][j + 1].status === 0) {
                                showCells(i + 1, j + 1);
                            }
                        }
                    }
                }
            } else {
                if (typeof aCells[i - 1] !== 'undefined') {
                    if (typeof aCells[i - 1][j - 1] !== 'undefined' &&
                        aCells[i - 1][j - 1].status === 0) {
                        showCells(i - 1, j - 1);
                    }

                    if (typeof aCells[i - 1][j] !== 'undefined' &&
                        aCells[i - 1][j].status === 0) {
                        showCells(i - 1, j);
                    }

                    if (typeof aCells[i - 1][j + 1] !== 'undefined' &&
                        aCells[i - 1][j + 1].status === 0) {
                        showCells(i - 1, j + 1);
                    }
                }

                if (typeof aCells[i][j - 1] !== 'undefined' &&
                    aCells[i][j - 1].status === 0) {
                    showCells(i, j - 1);
                }

                if (typeof aCells[i][j + 1] !== 'undefined' &&
                    aCells[i][j + 1].status === 0) {
                    showCells(i, j + 1);
                }

                if (typeof aCells[i + 1] !== 'undefined') {
                    if (typeof aCells[i + 1][j - 1] !== 'undefined' &&
                        aCells[i + 1][j - 1].status === 0) {
                        showCells(i + 1, j - 1);
                    }

                    if (typeof aCells[i + 1][j] !== 'undefined' &&
                        aCells[i + 1][j].status === 0) {
                        showCells(i + 1, j);
                    }

                    if (typeof aCells[i + 1][j + 1] !== 'undefined' &&
                        aCells[i + 1][j + 1].status === 0) {
                        showCells(i + 1, j + 1);
                    }
                }
            }
        }

        function isWin() {
            let temp = 0;

            foreachAllCells((i, j) => {
                if (aCells[i][j].isBomb) {
                    if (aCells[i][j].tag === 1) {
                        temp++;
                    }
                } else {
                    if (aCells[i][j].tag === 0) {
                        temp++;
                    }
                }
            });

            console.log(temp);
            if (temp === columns * rows) {
                alert('YOU WIN!!');

                endGamePauseClick();

                ajax(
                    'GET',
                    './test.php',
                    {test: "test", troy: "troy"},
                    response => {
                        console.log(response);
                        console.log('遊戲時間已記錄！');
                    },
                    status => {
                        console.log(status);
                        console.log('遊戲時間紀錄失敗！');
                    }
                );
            }
        }

        function initGame(startAndCleanBombs = true) {
            // 建立炸彈陣列
            if (startAndCleanBombs) {
                aBombs = createBombsArray(columns, rows, bombs);
                console.log(aBombs);
            }

            // 重置計時器
            clearInterval(timer);
            timer = null;
            let oSpan = document.getElementById('spanTime');
            oSpan.innerHTML = '時間(s)：0';

            // 建立格子陣列
            aCells = [];
            for (let i = 0; i < rows; i++) {
                aCells[i] = [];
                for (let j = 0; j < columns; j++) {
                    aCells[i].push(new Cells(i, j));
                }
            }

            // 把炸彈放進格子裡
            for (let i = 0; i < aBombs.length; i++) {
                let bombCell = aCells[Math.floor(aBombs[i] / columns)][aBombs[i] % columns];
                bombCell.isBomb = true;
            }

            // 計算每一格附近有幾顆炸彈
            countBombs();

            // 把遊戲畫上網頁
            let oDiv = document.getElementById('div1');

            oDiv.innerHTML = '';
            oDiv.oncontextmenu = ev => false;
            oDiv.onselectstart = ev => false;

            let iAlignLeft = (window.innerWidth - (CELL_WIDTH * columns)) / 2;

            foreachAllCells((i, j) => {
                let oChildDiv = document.createElement('div');

                // 初始格子的樣式
                oChildDiv.style.left = iAlignLeft + aCells[i][j].blockY * CELL_WIDTH + 'px';
                oChildDiv.style.top = aCells[i][j].blockX * CELL_WIDTH + 100 + 'px';
                oChildDiv.style.width = CELL_WIDTH + 'px';
                oChildDiv.style.height = CELL_WIDTH + 'px';
                oChildDiv.style.position = 'absolute';
                oChildDiv.style.border = 'black 1px solid';
                oChildDiv.style.textAlign = 'center';
                oChildDiv.style.lineHeight = CELL_WIDTH + 'px';
                oChildDiv.style.backgroundColor = aCells[i][j].backgroundColor;

                oChildDiv.addEventListener('mouseup', ev => {
                    if (!ev) ev = window.event;

                    if (ev.button === 0) {
                        if (timer === null) {
                            startTime();
                        }

                        showCells(i, j);

                        if (aCells[i][j].status !== -1) {
                            isWin();
                        }
                    }

                    if (ev.button === 2) {
                        if (timer === null) {
                            startTime();
                        }

                        if (aCells[i][j].status !== -1) {
                            aCells[i][j].rightClick(() => {
                                oChildDiv.style.backgroundColor = aCells[i][j].backgroundColor;
                            });

                            isWin();
                        }
                    }
                });

                oDiv.appendChild(oChildDiv);
            });
        }

        function startTime() {
            let oSpan = document.getElementById('spanTime');
            let passTime = 0;

            clearInterval(timer);
            timer = setInterval(() => {
                passTime++;
                oSpan.innerHTML = '時間(s)：' + passTime;
            }, 1000);
        }

        function autoSideBarMove(iTarget) {
            let oDiv = document.getElementById('div2');

            clearInterval(AutoSideBarTimer);
            AutoSideBarTimer = setInterval(() => {
                let speed = 0;

                if (oDiv.offsetLeft > iTarget) {
                    speed = -10;
                } else {
                    speed = 10;
                }

                if (oDiv.offsetLeft === iTarget) {
                    clearInterval(AutoSideBarTimer);
                } else {
                    oDiv.style.left = oDiv.offsetLeft + speed + 'px';
                }
            }, 30);
        }

        window.onload = () => {
            let oInput = document.getElementsByTagName('input');

            for (let i = 0; i < oInput.length; i++) {
                oInput[i].addEventListener('click', event => {
                    switch (oInput[i].id) {
                        case 'inputSimple':
                            columns = 8;
                            rows = 8;
                            bombs = 10;

                            initGame(true);

                            break;
                        case 'inputMid':
                            columns = 16;
                            rows = 16;
                            bombs = 40;

                            initGame(true);

                            break;
                        case 'inputHard':
                            columns = 30;
                            rows = 16;
                            bombs = 99;

                            initGame(true);

                            break;
                        case 'inputClean':
                            initGame(false);

                            break;
                    }
                });
            }

            // 左側遊戲說明自動彈出框
            let oDiv2 = document.getElementById('div2');

            let div2Left = window.getComputedStyle(oDiv2, null).getPropertyValue('left');

            div2Left = parseInt(div2Left.substr(0, div2Left.length - 2));

            oDiv2.onmouseover = () => autoSideBarMove(0);
            oDiv2.onmouseout = () => autoSideBarMove(div2Left);
        };
    </script>
</head>
<body>
<input id="inputSimple" type="button" value="初級"/>
<input id="inputMid" type="button" value="中級"/>
<input id="inputHard" type="button" value="高級"/>
<input id="inputClean" type="button" value="清除"/>

<span id="spanTime">時間(s)：0</span>

<hr/>

<div id="div1"></div>

<div id="div2">
    左鍵點擊展開
    <br/>
    右鍵標記炸彈
    <hr/>
    初級有10顆炸彈
    <br/>
    中級有40顆炸彈
    <br/>
    高級有99顆炸彈
    <hr/>
    清除會重新開始本次賽局
    <span>遊戲說明</span>
</div>
</body>
</html>